{% extends 'base.html' %}
{% block content %}

    <div class="signup-section" id="signup-section">
      {% csrf_token %}
      <input type="email" id="id_email">
      <input type="text" placeholder="username" id="id_username">
      <input type="password" placeholder="password" id="id_password">
      <span id="login-btn"><button onclick="login()">login</button></span>
      <span id="signup-btn"><button onclick="signupget()">signup</button> </span>
      <span id="signup-btn-submit"><button onclick="signup()">signup</button> </span>
    </div>
    <div class="message-section" id="message-section">
      <div class="message-list">

      </div>

      <button onclick="chat();">chat</button>
    <div id="message_box">
      <input type="text" id="id_message">
      <button onclick="send()">send</button>
    </div>
    </div>
<script>
  var token,content='',sender,receiver,sender_id,receiver_id;
  var chatsocket;


    document.getElementById('id_email').style.display = 'none'
    document.getElementById('signup-btn').style.display = 'none'
    document.getElementById('signup-btn-submit').style.display = 'none'
    document.getElementById('message_box').style.display = 'none'
    function login(){
      let username = document.getElementById('id_username').value;
      let password = document.getElementById('id_password').value;
      let csrf_token = document.querySelector('[name=csrfmiddlewaretoken]').value
      // let csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      url = 'http://127.0.0.1:8001/api/signin/'
      fetch(url,{
        method : 'POST',
        body : JSON.stringify({'username':username,'password' : password}),
        headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf_token
            }
      }).then(response => response.json()).then(data => {
        if(data.status == 'success'){
          localStorage.clear();
        localStorage.setItem('token',data.token)
        localStorage.setItem('user_id',data.user.id)
          localStorage.setItem('username',data.user.username)
          sender = data.user.username
          sender_id = data.user.id
          if(sender_id ==2){
            receiver = 'user'
            receiver_id = 3
          }else{
            receiver = 'admin'
            receiver_id = 2
          }
        document.getElementById('signup-section').style.display = 'none'
        }
      })
    }

    function messages_get(){
   token = localStorage.getItem('token')
     let url = 'http://127.0.0.1:8001/api/message/'
     fetch(url,{
      method: 'GET',
      headers :{
        'authorization' :'token '+token,
      },
     }).then(response => response.json()).then(data => {
 
     })
    }

    function send(){
     let message = document.getElementById('id_message').value
     chatsocket.send(JSON.stringify({
                'message': message
            }));
            document.getElementById('id_message').value = ''
    }
    function chat(){
      document.getElementById('message_box').style.display = 'block'
      if(sender_id>receiver_id){
        chatsocket = new WebSocket(
        'ws://'
            + window.location.host
            + '/ws/chat/'
            + sender 
            + sender_id
            + receiver
            + receiver_id
            + '/'
        );
      }else{
        chatsocket = new WebSocket(
        'ws://'
            + window.location.host
            + '/ws/chat/'
            + receiver
            + receiver_id
            + sender 
            + sender_id
            + '/'
        );
      }


        chatsocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            content += `<h5>${data.message}</h5>`
            document.querySelector('.message-list').innerHTML = content
            console.log(data.message)
        };

        chatsocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    }


</script>
{% endblock %}